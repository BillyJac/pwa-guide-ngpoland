<!doctype html>
<html>
    <head>
        <style>
            body {
                margin: 0;
            }

        </style>
        <link href="/indigo-pink.css" rel="stylesheet">

        <script>
            var module = {
                id: null
            };
        </script>
        <script src="/zone.js" defer></script>
        <script src="/Reflect.js" defer></script>
        <script src="/app.js" defer></script>

        <link rel="manifest" href="/manifest.webmanifest">
        <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png">
        <link rel="icon" type="image/png" href="/assets/favicons/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="/assets/favicons/favicon-16x16.png" sizes="16x16">
        <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#DE3541">
        <meta name="theme-color" content="#DE3541">

        <script defer>
            if (navigator.serviceWorker) {
                navigator.serviceWorker.register('/push-sw.js').then(() => {
                    console.log('Angular service worker installed')
                }, err => {
                    console.error('Angular service worker error:', err);
                });
            }
        </script>

        <script>
            window.addEventListener('beforeinstallprompt', function(e) {
                console.log('Showing install prompt');

                e.userChoice.then(function(choiceResult) {
                    console.log(choiceResult.outcome);
                });
            });
        </script>

    </head>

    <body>
        <app-root></app-root>
        <button id="btnNotification">Push</button>
        <script>

            function urlBase64ToUint8Array(base64String) {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');

                const rawData = window.atob(base64);
                const outputArray = new Uint8Array(rawData.length);

                for (let i = 0; i < rawData.length; ++i) {
                    outputArray[i] = rawData.charCodeAt(i);
                }
                return outputArray;
            }

            const vapidPublicKey = 'BHe82datFpiOOT0k3D4pieGt1GU-xx8brPjBj0b22gvmwl-HLD1vBOP1AxlDKtwYUQiS9S-SDVGYe_TdZrYJLw8';
            const convertedVapidKey = urlBase64ToUint8Array(vapidPublicKey);

            document.querySelector('#btnNotification').addEventListener('click', (e) => {

                // Request permission to send notifications
                Notification.requestPermission().then(() => {
                    // Get a reference to the SW
                    return navigator.serviceWorker.ready;
                }).then((sw) => {
                    // Tell it to subscribe with the push server
                    return sw.pushManager.subscribe({userVisibleOnly: true, applicationServerKey: convertedVapidKey});
                }).then((subscription) => {
                    // Send details about the subscription to the server
                    return fetch('http://localhost:8090/push', {
                        method: 'POST',
                        body: JSON.stringify({action: 'subscribe', subscription: subscription}),
                        headers: new Headers({'Content-Type': 'application/json'})
                    });
                });
            });
        </script>

    </body>
</html>
